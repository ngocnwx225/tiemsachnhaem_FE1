<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trang qu·∫£n l√Ω - Ti·ªám S√°ch Nh√† Em</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style_sidebar.css" />
  <link rel="stylesheet" href="../assets/css/style_common.css" />
  <link rel="stylesheet" href="../assets/css/style_index.css" />
  <style>
    .container-all {
      display: flex;
      margin: 0 auto;
      overflow: hidden;
      background-color: #F5F5F7;
    }
    body, h1, h2, h3, h4, p, button, input, select, textarea {
      font-family: 'Montserrat', sans-serif;
    }
  </style>
</head>
<body>
  <div class="container-all">
    <div id="sidebar-container" class="sidebar"></div>

    <div class="main">
      <div class="container">
        <h2>Xin ch√†o!</h2>
        <div class="overview-header">
          <p>ƒê√¢y l√† t·ªïng quan ho·∫°t ƒë·ªông c·ªßa ng√†y h√¥m nay.</p>
          <div class="time-filter">
            <button class="time-btn">Tu·∫ßn</button>
            <button class="time-btn active">Th√°ng</button>
            <button class="time-btn">NƒÉm</button>
            <button class="time-btn custom">
              <img src="../assets/images/M√°y in.png" width="16" style="margin-right: 4px;" />
              T√πy ch·ªânh
            </button>
          </div>
          <div id="custom-date-range" style="display: none; margin-top: 10px;">
            <label>T·ª´ ng√†y: <input type="date" id="from-date"></label>
            <label>ƒê·∫øn ng√†y: <input type="date" id="to-date"></label>
            <button id="apply-filter">L·ªçc</button>
          </div>
        </div>

        <div class="overview">
          <div class="card blue">
            <div class="icon">üì¶</div>
            <h3>T·ªïng ƒë∆°n h√†ng</h3>
            <div class="value" id="total-orders">...</div>
          </div>
          <div class="card green">
            <div class="icon">üõí</div>
            <h3>ƒê∆°n h√†ng m·ªõi</h3>
            <div class="value" id="new-orders">...</div>
          </div>
          <div class="card purple">
            <div class="icon">üë•</div>
            <h3>Kh√°ch h√†ng</h3>
            <div class="value" id="total-customers">...</div>
          </div>
          <div class="card yellow">
            <div class="icon">üí∞</div>
            <h3>Doanh thu</h3>
            <div class="value" id="revenue">...</div>
          </div>
        </div>

        <div class="section">
          <div class="box">
            <div class="box-header">
              <h4>S√°ch b√°n ch·∫°y</h4>
              <a href="#">Xem t·∫•t c·∫£</a>
            </div>
            <div id="product-list">ƒêang t·∫£i...</div>
          </div>

          <div class="box">
            <div class="box-header">
              <h4>ƒê∆°n h√†ng g·∫ßn ƒë√¢y</h4>
              <a href="#">Xem t·∫•t c·∫£</a>
            </div>
            <div id="recent-orders">ƒêang t·∫£i ƒë∆°n h√†ng g·∫ßn ƒë√¢y...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // G·ªçi t·ªïng kh√°ch h√†ng
    fetch('https://tiemsachnhaem-be-mu.vercel.app/api/users/count')
      .then(res => res.json())
      .then(data => {
        document.getElementById('total-customers').textContent = data.totalUsers || 0;
      })
      .catch(err => {
        console.error('L·ªói t·ªïng kh√°ch h√†ng:', err);
        document.getElementById('total-customers').textContent = '0';
      });

    // G·ªçi t·ªïng ƒë∆°n h√†ng
    fetch('https://tiemsachnhaem-be-mu.vercel.app/api/orders/count')
      .then(res => res.json())
      .then(data => {
        document.getElementById('total-orders').textContent = data.totalOrders || 0;
      })
      .catch(err => {
        console.error('L·ªói t·ªïng ƒë∆°n h√†ng:', err);
        document.getElementById('total-orders').textContent = '0';
      });

    // G·ªçi t·ªïng ƒë∆°n h√†ng m·ªõi (pending)
    fetch('https://tiemsachnhaem-be-mu.vercel.app/api/orders/count?status=pending')
      .then(res => res.json())
      .then(data => {
        document.getElementById('new-orders').textContent = data.count || 0;
      })
      .catch(err => {
        console.error('L·ªói ƒë∆°n h√†ng m·ªõi:', err);
        document.getElementById('new-orders').textContent = '0';
      });

    // G·ªçi t·ªïng doanh thu
    fetch('https://tiemsachnhaem-be-mu.vercel.app/api/orders/revenue')
      .then(res => res.json())
      .then(data => {
        document.getElementById('revenue').textContent = (data.totalRevenue || 0).toLocaleString('vi-VN') + ' VND';
      })
      .catch(err => {
        console.error('L·ªói doanh thu:', err);
        document.getElementById('revenue').textContent = '0 VND';
      });

    // G·ªçi s√°ch b√°n ch·∫°y
    fetch('https://tiemsachnhaem-be-mu.vercel.app/api/products/top-selling?limit=5')
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById('product-list').innerHTML = 'Kh√¥ng c√≥ s·∫£n ph·∫©m b√°n ch·∫°y.';
          return;
        }
        const html = data.map(p => `
          <div class="product-item">
            <strong>${p.name}</strong> - ƒê√£ b√°n: ${p.sold}
          </div>
        `).join('');
        document.getElementById('product-list').innerHTML = html;
      })
      .catch(err => {
        console.error('L·ªói s√°ch b√°n ch·∫°y:', err);
        document.getElementById('product-list').innerHTML = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.';
      });

    // X·ª≠ l√Ω l·ªçc ƒë∆°n h√†ng g·∫ßn ƒë√¢y theo th·ªùi gian
    function loadRecentOrders(label, fromDate, toDate) {
      let url = `https://tiemsachnhaem-be-mu.vercel.app/api/orders/recent?limit=3`;

      if (label !== 't√πy ch·ªânh') {
        url += `&filter=${label}`;  // backend c·∫ßn hi·ªÉu c√°c filter: tu·∫ßn, th√°ng, nƒÉm
      } else if (fromDate && toDate) {
        url += `&from=${fromDate}&to=${toDate}`;  // t√πy ch·ªânh t·ª´ ng√†y - ƒë·∫øn ng√†y
      }

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) {
            document.getElementById('recent-orders').innerHTML = 'Kh√¥ng c√≥ ƒë∆°n h√†ng g·∫ßn ƒë√¢y.';
            return;
          }
          const html = data.map(order => {
            const statusMap = {
              pending: { text: "pending", class: "red" },
              delivered: { text: "delivered", class: "green" },
              canceled: { text: "canceled", class: "gray" },
              shipped: { text: "shipped", class: "blue" },
              processing: { text: "processing", class: "orange" }
            };
            const raw = order.status?.toLowerCase();
            const status = statusMap[raw] || { text: raw || "unknown", class: "gray" };

            return `
              <div class="order-item">
                <div class="order-left">
                  <img src="../assets/images/Container.png" width="32" height="32" />
                  <div class="order-info">
                    <strong>${order.customerId}</strong>
                    <span>#${order.orderId} ‚Ä¢ ${order.productQuantity} s·∫£n ph·∫©m</span>
                  </div>
                </div>
                <div class="order-dates">
                  <span>D·ª± ki·∫øn giao ng√†y:</span>${new Date(order.orderDate).toLocaleDateString('vi-VN')}
                  <span>Ng√†y giao:</span>${order.status === 'delivered' ? new Date(order.updatedAt).toLocaleDateString('vi-VN') : "---"}
                </div>
                <div class="order-status">
                  <div class="order-price">${order.totalAmount.toLocaleString()} VND</div>
                  <div class="status ${status.class}">${status.text}</div>
                </div>
              </div>
            `;
          }).join('');
          document.getElementById('recent-orders').innerHTML = html;
        })
        .catch(err => {
          console.error('L·ªói ƒë∆°n h√†ng g·∫ßn ƒë√¢y:', err);
          document.getElementById('recent-orders').innerHTML = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.';
        });
    }

    // G·∫Øn s·ª± ki·ªán c√°c n√∫t th·ªùi gian
    document.querySelectorAll(".time-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".time-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const label = btn.innerText.trim().toLowerCase();

        if (label === "t√πy ch·ªânh") {
          document.getElementById("custom-date-range").style.display = "block";
        } else {
          document.getElementById("custom-date-range").style.display = "none";
          loadRecentOrders(label);
        }
      });
    });

    // G·∫Øn s·ª± ki·ªán n√∫t l·ªçc t√πy ch·ªânh
    document.getElementById("apply-filter").addEventListener("click", () => {
      const from = document.getElementById("from-date").value;
      const to = document.getElementById("to-date").value;

      if (!from || !to) {
        alert("Vui l√≤ng ch·ªçn c·∫£ 2 ng√†y.");
        return;
      }
      loadRecentOrders('t√πy ch·ªânh', from, to);
    });

    // T·∫£i m·∫∑c ƒë·ªãnh theo th√°ng khi load trang
    loadRecentOrders('th√°ng');
  </script>
  <script src="../assets/js/sidebar.js"></script>
</body>
</html>
